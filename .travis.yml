os: linux
language: python

env:
  global:
   - TWINE_REPOSITORY_URL=https://test.pypi.org/legacy/
   - TWINE_USERNAME=ikus060
   #- TWINE_PASSWORD=
   - secure: "aYcAkWkQG1FH3zjpt5H9JMnhgf4YRntV5Wa+g/tSwqLihAG+tz3GATMO8PCz19UMUHhuh6VN4C2XLbcpDyyTlIYLoZerENIxfc4p62NuyQfQi4uPWxzGJnYW5x6zmf40ANHNMTwlCBcn3aifHS5/Mjgi7M8/WzAaiCs1wJA3T4EqhJMLUTA/7gG3H9XWXCZdOz4rLh1OvOxR72Y65t0YyJZD9vDYy6yzcad8AnMBF0ijDO0WoJMYYGpCRdxvDEDlPh6OLzEQRwlYBcIUBnTaHUtqxl3eeNhOmBW4xGQzp4RxsvhNNiQ7ryetdU0ZDUOCYE8F40RRtb01NBJ1tNKvblWHcFN6RaCXPyVLOlOKzPslyJIFuNtU47+wvxdNUb5AtXPQOg9qhI5eTEeaqtVUuFcPQ8egRi1C1qQ+ukkYEaQMofA7TpNzrSfAQXF0ttNx5wqKJaYmDfiNtO0nmIcNSZ5LztHWQBR9iHQ3XVL9CGllq/wcbx0EivFths5V6bNoHTb1xT3nCOZFBQslhoAi6mfRAcmrHmQn80Aw8gtzjdY0xOIkaudzQcbjZJouMLUiXwzUH0ejLowR0lHrCnfm8jv74N84GOfllTPSPClWp+YuzYG+ftB7+ATigXkm2VsEFNiACWNLCpqAgI2HljSePCHM4UHGmvqZbsr3xkJhnh0="

jobs:
  # Code style
  allow_failures:
   - env: TOXENV=flake8
          PLAT=manylinux2010_x86_64
          PYBIN=/opt/python/cp37-cp37m/bin
  include:
  # Test
   - stage: test
     env: TOXENV=py35
          PLAT=manylinux2010_x86_64
          PYBIN=/opt/python/cp35-cp35m/bin
          
   - stage: test
     env: TOXENV=py36
          PLAT=manylinux2010_x86_64
          PYBIN=/opt/python/cp36-cp36m/bin
     
   - stage: test
     env: TOXENV=py37
          PLAT=manylinux2010_x86_64
          PYBIN=/opt/python/cp37-cp37m/bin
     
   - stage: test
     env: TOXENV=py38
          PLAT=manylinux2010_x86_64
          PYBIN=/opt/python/cp38-cp38/bin

   - stage: test
     env: TOXENV=flake8
          PLAT=manylinux2010_x86_64
          PYBIN=/opt/python/cp37-cp37m/bin
  
  # Deploy
   - stage: deploy
     env: PLAT=manylinux2010_x86_64
          PYBIN=/opt/python/cp36-cp36m/bin
     
   - stage: deploy
     env: PLAT=manylinux2010_x86_64
          PYBIN=/opt/python/cp37-cp37m/bin
     
   - stage: deploy
     env: PLAT=manylinux2010_x86_64
          PYBIN=/opt/python/cp38-cp38/bin

install:
  - docker pull quay.io/pypa/$PLAT

script:
  - docker run --rm -e TWINE_REPOSITORY_URL -e TWINE_USERNAME -e TWINE_PASSWORD -e PLAT -e PYBIN -e TOXENV -v `pwd`:/rdiff-backup/ quay.io/pypa/$PLAT /rdiff-backup/tools/build-linux.sh $TRAVIS_BUILD_STAGE_NAME
